<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>App Voz ‚Äì Paradas e Produ√ß√£o</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;max-width:600px;margin:auto}
    label{display:block;margin-top:12px;font-weight:bold}
    input{width:100%;padding:8px;margin-top:4px;font-size:16px}
    button{margin-top:20px;padding:12px 20px;font-size:18px;cursor:pointer}
    #status{margin-top:15px;font-weight:bold;color:#006600}
    #resumo{margin-top:20px;background:#f3f3f3;padding:12px;border-radius:8px;display:none}
    #menuPosEnvio button{margin-right:10px}
  </style>
</head>
<body>
<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<!-- Tela de login -->
<div id="loginDiv">
  <h2>Login</h2>
  <label>Usu√°rio:<input id="usuarioLogin" /></label>
  <label>Senha:<input id="senhaLogin" type="password" /></label>
  <button id="loginBtn">Entrar</button>
  <div id="loginStatus"></div>
</div>

<!-- Tela principal de apontamento -->
<div id="appDiv" style="display:none">
  <h2>Apontamento de Parada (DISP)</h2>
  <p>Cada vez que clicar, o app vai pedir o pr√≥ximo campo. Fale s√≥ o valor.</p>

  <label>Turma:<input id="turma" readonly /></label>
  <label>Linha de Produ√ß√£o:<input id="linha" readonly /></label>
  <label>Data In√≠cio:<input id="dataInicio" readonly /></label>
  <label>Data Final:<input id="dataFinal" readonly /></label>
  <label>Hora In√≠cio:<input id="horaInicio" readonly /></label>
  <label>Hora Final:<input id="horaFinal" readonly /></label>
  <label>Instala√ß√£o:<input id="instalacao" readonly /></label>
  <label>OP:<input id="op" readonly /></label>
  <label>Motivo:<input id="motivo" readonly /></label>
  <label>Origem:<input id="origem" readonly /></label>
  <label>Classifica√ß√£o:<input id="classificacao" readonly /></label>
  <!-- Nota PM ser√° criada dinamicamente se necess√°rio -->

  <button id="startBtn">Come√ßar preenchimento</button>
  <button id="repetirBtn" style="display:none">üîÅ Repetir campo</button>
  <button id="cancelarBtn" style="display:none">üßπ Cancelar e reiniciar</button>
  <button id="enviarBtn" style="display:none">Enviar dados</button>

  <div id="status"></div>
  <div id="resumo"></div>
  <div id="menuPosEnvio" style="display:none">
    <button id="novaParadaBtn">‚ûï Nova parada</button>
    <button id="apontarProducaoBtn">üì¶ Apontar produ√ß√£o</button>
    <button id="encerrarBtn">‚èπÔ∏è Encerrar</button>
  </div>
</div>

<script>
const beep=document.getElementById('beep');
let token=null;
let usuarioLogado=null;
const loginBtn=document.getElementById('loginBtn');
loginBtn.onclick = () => {
  document.getElementById('loginDiv').style.display = 'none';
  document.getElementById('appDiv').style.display = 'block';
};
};

// Lista de campos iniciais
let campos=[
  {id:'turma',prompt:'Fale a Turma (ex.: 01 ou 02)'},
  {id:'linha',prompt:'Fale a Linha de Produ√ß√£o (ex.: coladeira A, B, C ou F)'},
  {id:'dataInicio',prompt:'Fale a Data In√≠cio (ex.: 0407)'},
  {id:'dataFinal',prompt:'Fale a Data Final (ex.: 0407)'},
  {id:'horaInicio',prompt:'Fale a Hora In√≠cio (ex.: zero sete zero zero)'},
  {id:'horaFinal',prompt:'Fale a Hora Final (ex.: um quatro tr√™s zero)'},
  {id:'instalacao',prompt:'Fale o Local da Instala√ß√£o'},
  {id:'op',prompt:'Fale o n√∫mero da OP'},
  {id:'motivo',prompt:'Fale o Motivo'},
  {id:'origem',prompt:'Fale a Origem'},
  {id:'classificacao',prompt:'Fale a Classifica√ß√£o'}
];
let campoAtual=0;

// Utilidades de convers√£o
function mapearPalavrasParaDigitos(str){
  const mapa={'zero':'0','um':'1','uma':'1','dois':'2','tres':'3','tr√™s':'3','quatro':'4','cinco':'5','seis':'6','sete':'7','oito':'8','nove':'9'};
  return str.toLowerCase().split(/\s+/).map(p=>mapa[p]??p).join('');
}
function numeroPuro(str){return mapearPalavrasParaDigitos(str).replace(/\D/g,'');}
function converterData(resp){
  let limp=mapearPalavrasParaDigitos(resp.toLowerCase().replace(/barra/g,''));
  limp=limp.replace(/\s+/g,'');
  if(/^\d{4}$/.test(limp)){
    const dia=limp.slice(0,2);
    const mes=limp.slice(2,4);
    const ano=new Date().getFullYear();
    return `${dia}/${mes}/${ano}`;
  }
  return resp;
}
function converterHora(resp){
  const num=numeroPuro(resp);
  if(/^\d{4}$/.test(num)) return num.slice(0,2)+':'+num.slice(2);
  return resp;
}
function converterTurma(val){
  const mapa={'01':'Turma 01 ‚Äì 5x2','02':'Turma 02 ‚Äì 6x1','03':'Turma 03 ‚Äì Noturno'};
  return mapa[val]||val;
}
function converterLinha(val){
  const mapa={'coladeira a':'LINHA_A','coladeira b':'LINHA_B','coladeira c':'LINHA_C','coladeira f':'LINHA_F'};
  return mapa[val.toLowerCase()]||val;
}

// Elementos DOM
const statusDiv=document.getElementById('status');
const startBtn=document.getElementById('startBtn');
const enviarBtn=document.getElementById('enviarBtn');
const repetirBtn=document.getElementById('repetirBtn');
const cancelarBtn=document.getElementById('cancelarBtn');

// Reconhecimento de voz
const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
if(!SpeechRecognition){
  statusDiv.textContent='Seu navegador n√£o suporta reconhecimento de voz.';
  startBtn.disabled=true;
}else{
  const recognition=new SpeechRecognition();
  recognition.lang='pt-BR';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.onstart=()=>{
    beep.play();
    statusDiv.textContent=campos[campoAtual].prompt+'... ouvindo.';
    startBtn.disabled=true;
    repetirBtn.style.display='none';
    cancelarBtn.style.display='none';
  };

  recognition.onerror=e=>{
    statusDiv.textContent='Erro: '+e.error+'. Clique em Repetir ou Cancelar.';
    startBtn.disabled=false;
    repetirBtn.style.display='inline-block';
    cancelarBtn.style.display='inline-block';
  };

  recognition.onspeechend=()=>recognition.stop();

  recognition.onresult=e=>{
    let resposta=e.results[0][0].transcript.trim();
    const campoId=campos[campoAtual].id;

    if(campoId==='turma') resposta=converterTurma(resposta);
    if(campoId==='linha') resposta=converterLinha(resposta);
    if(campoId.includes('data')) resposta=converterData(resposta);
    if(campoId.includes('hora')) resposta=converterHora(resposta);
    if(campoId==='op'||campoId==='nota') resposta=numeroPuro(resposta);

    document.getElementById(campoId).value=resposta;
    statusDiv.textContent='Preenchido: '+campoId+' ‚Üí '+resposta;

    // Se motivo exige Nota PM
    if(campoId==='motivo'){
      const mot=resposta.toLowerCase();
      if((mot.includes('mec')||mot.includes('el√©tr')||mot.includes('eletr'))&&!document.getElementById('nota')){
        const label=document.createElement('label');
        label.innerHTML='Nota PM:<input id="nota" readonly />';
        enviarBtn.before(label);
        campos.splice(campoAtual+1,0,{id:'nota',prompt:'Fale o n√∫mero da Nota PM'});
      }
    }

    campoAtual++;
    if(campoAtual<campos.length){
      startBtn.textContent='Pr√≥ximo: '+campos[campoAtual].prompt;
      repetirBtn.style.display='inline-block';
      cancelarBtn.style.display='inline-block';
    }else{
      startBtn.textContent='Preenchimento conclu√≠do';
      startBtn.disabled=true;
      statusDiv.textContent='‚úÖ Todos os campos preenchidos.';
      enviarBtn.style.display='inline-block';
      repetirBtn.style.display='none';
      cancelarBtn.style.display='none';
    }
    startBtn.disabled=false;
  };

  startBtn.onclick=()=>{
    if(campoAtual<campos.length) recognition.start();
  };
  repetirBtn.onclick=()=>{
    if(campoAtual>0) campoAtual--;
    recognition.start();
  };
}

// Resumo e envio
function montarResumoDados(d){
  let html='<h3>Resumo do envio</h3><ul>';
  Object.entries(d).forEach(([k,v])=>{html+='<li><strong>'+k+':</strong> '+v+'</li>';});
  html+='</ul>';return html;
}

enviarBtn.onclick=()=>{
  const dados={usuario:usuarioLogado};
  let faltando=false;
  campos.forEach(c=>{
    const el=document.getElementById(c.id);
    if(el){dados[c.id]=el.value;if(el.value.trim()==='') faltando=true;}
  });
  if(faltando){alert('Por favor, preencha todos os campos antes de enviar.');return;}
  if(dados.nota==='') delete dados.nota;
  const resumoDiv=document.getElementById('resumo');
  resumoDiv.innerHTML=montarResumoDados(dados);
